<p-toast></p-toast>
 
 
<p-table
  #dt
  [value]="loading ? skeletonRows : beneficiaires"
  [paginator]="true" [rows]="10" 
  [rowsPerPageOptions]="[10,20,30]"
  [showCurrentPageReport]="false"
  currentPageReportTemplate="Liste {first} / {last}"
  [showFirstLastIcon]="false"
  responsiveLayout="scroll"
  dataKey="id"
  [globalFilterFields]="['nom_complet','phone']"
  class="w-full">
  <ng-template pTemplate="caption">
  <div class="flex flex-column md:flex-row md:align-items-center gap-2 md:gap-3 w-full">

    <!-- Bouton : full en mobile, 50% dès md -->
    <div class="w-full md:flex-1">
      <button
        pButton pRipple
        label="Ajouter un bénéficiaire"
        icon="pi pi-plus"
        class="w-full h-3rem"
        (click)="openNew()">
      </button>
    </div>  

    <!-- Recherche : full en mobile, 50% dès md -->
    <div class="w-full md:flex-1">
      <span class="p-input-icon-left w-full block">
        <i class="pi pi-search"></i>
        <input
          pInputText
          type="text"
          (input)="onGlobalFilter(dt, $event)"
          placeholder="Rechercher..."
          class="w-full h-3rem" />
      </span>
    </div>

  </div>
</ng-template>

  <!-- En-têtes (desktop) -->
  <ng-template pTemplate="header">
    <tr class="show-desktop">
      <th pSortableColumn="nom_complet">Nom <p-sortIcon field="nom_complet"></p-sortIcon></th>
      <th pSortableColumn="phone">Téléphone <p-sortIcon field="phone"></p-sortIcon></th>
      <th class="text-center" style="width:10rem">Actions</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-b>
    <!-- Skeleton desktop -->
    <tr *ngIf="loading" class="show-desktop">
      <td><p-skeleton width="12rem" /></td>
      <td><p-skeleton width="10rem" /></td>
      <td class="text-center"><p-skeleton width="6rem" height="2rem" borderRadius="1rem" /></td>
    </tr>

    <!-- Ligne desktop -->
    <tr *ngIf="!loading" class="show-desktop">
      <td>
      <div class="flex align-items-center gap-2">
        <div class="avatar-initials">{{ getInitials(b.nom_complet) }}</div>
        <span class="font-medium text-900">{{ b.nom_complet }}</span>
      </div>
    </td>
      <td>{{ b.phone | phoneFormat:'GN' }}</td>
      <td class="text-center">
        <div class="inline-flex gap-2">
          <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-success"
                  (click)="editBeneficiaire(b)"></button>
          <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-danger"
                  (click)="deleteBeneficiaire(b)"></button>
        </div>
      </td>
    </tr>

    <!-- Carte mobile -->
    <tr class="show-mobile">
      <td colspan="3" class="p-0">
        <div class="mobile-card">
          <div class="flex align-items-center gap-3">
            <div class="avatar-initials">{{ getInitials(b.nom_complet) }}</div>
            <div>
              <div class="text-900 font-medium line-height-2">{{ b.nom_complet }}</div>
              <div class="text-600 text-sm">{{ b.phone | phoneFormat:'GN' }}</div>
            </div>
          </div>
          <div class="flex gap-2">
            <button pButton pRipple icon="pi pi-pencil"
                    class="p-button-rounded p-button-text p-button-success"
                    (click)="editBeneficiaire(b)"></button>
            <button pButton pRipple icon="pi pi-trash"
                    class="p-button-rounded p-button-text p-button-danger"
                    (click)="deleteBeneficiaire(b)"></button>
          </div>
        </div>
      </td>
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr><td colspan="3" class="text-center py-5">Aucun bénéficiaire</td></tr>
  </ng-template>
</p-table>


<p-dialog
            [(visible)]="beneficiaireDialog"
            [style]="{ width: '450px' }"
            header="Détails du Beneficiaire"
            [modal]="true"
            class="p-fluid"
        >
            <ng-template pTemplate="content">
                
                <div class="field">
                    <label for="name">Nom</label>
                    <input
                        type="text"
                        pInputText
                        id="name"
                        [(ngModel)]="beneficiaire.nom"
                        required
                        autofocus
                        [ngClass]="{
                            'ng-invalid ng-dirty': submitted && !beneficiaire.nom
                        }"
                    />
                    <small
                        class="ng-dirty ng-invalid"
                        *ngIf="submitted && !beneficiaire.nom"
                        >Nom is required.</small
                    >
                </div>

                <div class="field">
                    <label for="name">Prenom</label>
                    <input
                        type="text"
                        pInputText
                        id="name"
                        [(ngModel)]="beneficiaire.prenom"
                        required
                        autofocus
                        [ngClass]="{
                            'ng-invalid ng-dirty': submitted && !beneficiaire.prenom
                        }"
                    />
                    <small
                        class="ng-dirty ng-invalid"
                        *ngIf="submitted && !beneficiaire.prenom"
                        >Prenom is required.</small
                    >
                </div>
                <div class="field">
                    <label for="country">Pays</label>
                    <p-dropdown
                        inputId="country"
                        [options]="countries"
                        optionLabel="name"
                        [filter]="true"
                        filterBy="name,code"
                        [showClear]="false"
                        placeholder="Sélectionner un pays"
                        class="w-full"
                        [(ngModel)]="selectedCountry"
                        (onChange)="onCountryChange($event.value)"
                    >
                        <ng-template pTemplate="selectedItem" let-country>
                            <ng-container *ngIf="country">
                                <div class="flex align-items-center">
                                    <img
                                        src="assets/demo/images/flag/flag_placeholder.png"
                                        [class]="'mr-2 flag flag-' + country.code.toLowerCase()"
                                        style="width:18px"
                                    />
                                    <div>{{ country.name }}</div>
                                </div>
                            </ng-container>
                        </ng-template>
                        <ng-template pTemplate="item" let-country>
                            <div class="flex align-items-center">
                                <img
                                    src="assets/demo/images/flag/flag_placeholder.png"
                                    [class]="'mr-2 flag flag-' + country.code.toLowerCase()"
                                    style="width:18px"
                                />
                                <div>{{ country.name }}</div>
                            </div>
                        </ng-template>
                    </p-dropdown>
                </div>
                <div class="field">
                    <label for="name">Téléphone</label>
                    <input
                        type="text"
                        pInputText
                        id="phone"
                        [(ngModel)]="beneficiaire.phone"
                        (input)="onPhoneInput($event)"
                        required
                        [ngClass]="{
                            'ng-invalid ng-dirty': submitted && !beneficiaire.phone
                        }"
                    />
                    <small
                        class="ng-dirty ng-invalid"
                        *ngIf="submitted && !beneficiaire.phone"
                        >Téléphone is required.</small
                    >
                </div>
           
            </ng-template>

            <ng-template pTemplate="footer">
                <button
                    pButton
                    pRipple
                    label="Annuler"
                    icon="pi pi-times"
                    class="p-button-text"
                    (click)="hideDialog()"
                ></button>
                <button
                    pButton
                    pRipple
                    label="Enregistrer"
                    icon="pi pi-check"
                    class="p-button-text"
                    [loading]="loading"
                    (click)="saveBeneficiaire()"
                ></button>
            </ng-template>
        </p-dialog>


        <!-- Confirmer suppression unitaire -->
<p-dialog
  [(visible)]="deleteBeneficiaireDialog"
  [style]="{ width: '400px' }"
  header="Confirmer la suppression"
  [modal]="true"
>
  <p>Voulez-vous vraiment supprimer le bénéficiaire <b>{{ current?.nom_complet || (current?.prenom + ' ' + current?.nom) }}</b> ?</p>
  <ng-template pTemplate="footer">
    <button pButton pRipple label="Annuler" icon="pi pi-times" class="p-button-text"      (click)="deleteBeneficiaireDialog = false"></button>
    <button pButton pRipple label="Supprimer" icon="pi pi-trash" class="p-button-danger" [loading]="loading" (click)="confirmDeleteBeneficiaire()"></button>
  </ng-template>
</p-dialog>
